<!DOCTYPE html>
<!-- saved from url=(0051)file:///C:/Users/BillCurry/Downloads/callnotes.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CallNotes ‚Äî Phone Call Notebook</title>
<link href="./CallNotesv2.0 ‚Äî Phone Call Notebook_files/css2" rel="stylesheet">
<style>
  :root {
    --bg-deep: #0f1117;
    --bg-sidebar: #161822;
    --bg-main: #1a1d2b;
    --bg-card: #1f2335;
    --bg-input: #252840;
    --border: #2a2d42;
    --border-light: #353856;
    --text-primary: #e4e6f0;
    --text-secondary: #8b8fa8;
    --text-muted: #5c6080;
    --accent: #6c8cff;
    --accent-glow: rgba(108, 140, 255, 0.15);
    --accent-hover: #8aa4ff;
    --green: #5ae0a0;
    --green-glow: rgba(90, 224, 160, 0.12);
    --red: #ff6b7a;
    --red-glow: rgba(255, 107, 122, 0.12);
    --amber: #f0b865;
    --amber-glow: rgba(240, 184, 101, 0.1);
    --purple: #b08cff;
    --sidebar-w: 260px;
    --topbar-h: 56px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-deep);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    display: flex;
  }

  /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
  .sidebar {
    width: var(--sidebar-w);
    min-width: var(--sidebar-w);
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    height: 100vh;
    z-index: 10;
  }

  .sidebar-brand {
    padding: 20px 20px 16px;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-brand h1 {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }

  .sidebar-brand p {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  /* Dashboard button */
  .dashboard-btn {
    margin: 12px 10px 4px;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 13.5px;
    font-weight: 600;
    color: var(--amber);
    background: var(--amber-glow);
    border: 1px solid rgba(240, 184, 101, 0.15);
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }

  .dashboard-btn:hover {
    background: rgba(240, 184, 101, 0.18);
    border-color: rgba(240, 184, 101, 0.3);
  }

  .dashboard-btn.active {
    background: rgba(240, 184, 101, 0.22);
    border-color: var(--amber);
  }

  .dashboard-btn .badge {
    margin-left: auto;
    background: var(--amber);
    color: var(--bg-deep);
    font-size: 11px;
    font-weight: 700;
    padding: 1px 7px;
    border-radius: 10px;
    font-family: 'JetBrains Mono', monospace;
  }

  .sidebar-section-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.8px;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 14px 20px 8px;
  }

  .folder-list {
    flex: 1;
    overflow-y: auto;
    padding: 4px 10px;
  }

  .folder-list::-webkit-scrollbar { width: 4px; }
  .folder-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .folder-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-size: 13.5px;
    font-weight: 500;
    color: var(--text-secondary);
    position: relative;
  }

  .folder-item:hover {
    background: rgba(108, 140, 255, 0.06);
    color: var(--text-primary);
  }

  .folder-item.active {
    background: var(--accent-glow);
    color: var(--accent);
  }

  .folder-item .dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .folder-item .count {
    margin-left: auto;
    font-size: 11px;
    background: var(--bg-input);
    padding: 1px 7px;
    border-radius: 10px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .folder-item.active .count {
    background: rgba(108, 140, 255, 0.15);
    color: var(--accent);
  }

  .folder-item .delete-folder {
    display: none;
    position: absolute;
    right: 8px;
    background: none;
    border: none;
    color: var(--red);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
    border-radius: 4px;
    opacity: 0.6;
  }

  .folder-item:hover .delete-folder { display: block; }
  .folder-item:hover .count { display: none; }
  .folder-item .delete-folder:hover { opacity: 1; }

  .add-folder-btn {
    margin: 8px 10px 16px;
    padding: 9px 12px;
    background: transparent;
    border: 1px dashed var(--border-light);
    border-radius: 8px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .add-folder-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: var(--accent-glow);
  }

  .sidebar-footer {
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .export-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
  }
  .export-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ‚îÄ‚îÄ Main Area ‚îÄ‚îÄ */
  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .topbar {
    height: var(--topbar-h);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
    background: var(--bg-main);
    flex-shrink: 0;
  }

  .topbar-folder-name {
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .topbar-folder-name .dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }

  .topbar-search {
    margin-left: auto;
    position: relative;
  }

  .topbar-search input {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 7px 14px 7px 34px;
    color: var(--text-primary);
    font-size: 13px;
    font-family: 'DM Sans', sans-serif;
    width: 220px;
    transition: all 0.2s;
    outline: none;
  }

  .topbar-search input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
    width: 280px;
  }

  .topbar-search input::placeholder { color: var(--text-muted); }

  .topbar-search svg {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
  }

  .new-note-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #fff;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .new-note-btn:hover {
    background: var(--accent-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(108, 140, 255, 0.3);
  }

  /* ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
  .content-area {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* ‚îÄ‚îÄ Notes List ‚îÄ‚îÄ */
  .notes-list {
    width: 320px;
    min-width: 320px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    background: var(--bg-main);
  }

  .notes-list::-webkit-scrollbar { width: 4px; }
  .notes-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .note-preview {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.12s;
    position: relative;
  }

  .note-preview:hover { background: rgba(108, 140, 255, 0.04); }

  .note-preview.active {
    background: var(--accent-glow);
    border-left: 3px solid var(--accent);
  }

  .note-preview-title {
    font-weight: 600;
    font-size: 13.5px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .note-preview-snippet {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 6px;
  }

  .note-preview-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .note-preview-tasks {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    color: var(--amber);
    font-size: 11px;
  }

  .note-preview .delete-note {
    display: none;
    position: absolute;
    top: 12px; right: 12px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    color: var(--red);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 4px;
  }
  .note-preview:hover .delete-note { display: block; }
  .note-preview .delete-note:hover { background: var(--red-glow); }

  /* ‚îÄ‚îÄ Editor ‚îÄ‚îÄ */
  .editor-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: var(--bg-deep);
    min-width: 0;
  }

  .editor-header {
    padding: 18px 28px 12px;
    border-bottom: 1px solid var(--border);
    background: var(--bg-main);
  }

  .editor-title-input {
    width: 100%;
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 20px;
    font-weight: 700;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    margin-bottom: 6px;
  }

  .editor-title-input::placeholder { color: var(--text-muted); }

  .editor-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 12px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
  }

  .editor-meta .tag {
    background: var(--accent-glow);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
  }

  .caller-input-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }

  .caller-input-row label {
    font-size: 12px;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .caller-input {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 4px 10px;
    color: var(--text-primary);
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    flex: 1;
    max-width: 300px;
  }

  .caller-input:focus { border-color: var(--accent); }

  .editor-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .editor-body::-webkit-scrollbar { width: 6px; }
  .editor-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ‚îÄ‚îÄ Line-by-line note editor ‚îÄ‚îÄ */
  .note-lines-area {
    flex: 1;
    padding: 16px 28px;
  }

  .note-line {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    margin-bottom: 2px;
    position: relative;
    border-radius: 6px;
    padding: 4px 6px;
    transition: background 0.1s;
  }

  .note-line:hover {
    background: rgba(255,255,255,0.02);
  }

  .note-line-number {
    font-size: 11px;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
    width: 22px;
    text-align: right;
    padding-top: 7px;
    flex-shrink: 0;
    opacity: 0.5;
    user-select: none;
  }

  .note-line-input {
    flex: 1;
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 14px;
    line-height: 1.7;
    font-family: 'DM Sans', sans-serif;
    outline: none;
    padding: 4px 0;
    min-width: 0;
  }

  .note-line-input::placeholder { color: var(--text-muted); opacity: 0.4; }

  .note-line-input.has-task {
    border-bottom: 1px dashed rgba(240, 184, 101, 0.25);
  }

  .line-task-btn {
    flex-shrink: 0;
    background: none;
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 11px;
    padding: 3px 6px;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.12s;
    opacity: 0;
    margin-top: 4px;
    white-space: nowrap;
  }

  .note-line:hover .line-task-btn { opacity: 1; }

  .line-task-btn:hover {
    border-color: var(--amber);
    color: var(--amber);
    background: var(--amber-glow);
  }

  .line-task-btn.has-task {
    opacity: 1;
    border-color: var(--amber);
    color: var(--amber);
    background: var(--amber-glow);
  }

  .line-task-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 2px;
    padding: 3px 8px;
    background: var(--amber-glow);
    border-radius: 4px;
    font-size: 11px;
    color: var(--amber);
    flex-shrink: 0;
  }

  .line-task-indicator .assignee { font-weight: 600; }
  .line-task-indicator .due { font-family: 'JetBrains Mono', monospace; font-size: 10px; }

  .line-task-indicator .remove-task {
    cursor: pointer;
    color: var(--red);
    margin-left: 4px;
    opacity: 0.6;
  }
  .line-task-indicator .remove-task:hover { opacity: 1; }

  .line-task-indicator .email-link {
    cursor: pointer;
    color: var(--accent);
    text-decoration: none;
    margin-left: 2px;
  }
  .line-task-indicator .email-link:hover { color: var(--accent-hover); }

  .line-task-complete {
    cursor: pointer;
    margin-left: 2px;
    opacity: 0.7;
  }
  .line-task-complete:hover { opacity: 1; }

  /* ‚îÄ‚îÄ Dashboard View ‚îÄ‚îÄ */
  .dashboard-view {
    flex: 1;
    overflow-y: auto;
    padding: 28px 36px;
    display: none;
  }

  .dashboard-view.active { display: block; }

  .dashboard-view::-webkit-scrollbar { width: 6px; }
  .dashboard-view::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .dash-header {
    margin-bottom: 28px;
  }

  .dash-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 26px;
    font-weight: 800;
    margin-bottom: 6px;
  }

  .dash-header p {
    color: var(--text-muted);
    font-size: 14px;
  }

  .dash-stats {
    display: flex;
    gap: 16px;
    margin-bottom: 28px;
  }

  .dash-stat-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px 22px;
    flex: 1;
    min-width: 0;
  }

  .dash-stat-card .label {
    font-size: 12px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .dash-stat-card .value {
    font-size: 28px;
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
  }

  .dash-stat-card.overdue .value { color: var(--red); }
  .dash-stat-card.due-soon .value { color: var(--amber); }
  .dash-stat-card.upcoming .value { color: var(--accent); }
  .dash-stat-card.completed .value { color: var(--green); }

  .dash-section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-secondary);
    margin: 24px 0 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dash-section-title .dot-ind {
    width: 8px; height: 8px;
    border-radius: 50%;
  }

  .dash-filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .dash-filter-btn {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-secondary);
    padding: 5px 12px;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.12s;
  }

  .dash-filter-btn:hover { border-color: var(--accent); color: var(--text-primary); }
  .dash-filter-btn.active { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

  .task-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    margin-bottom: 10px;
    display: flex;
    align-items: flex-start;
    gap: 14px;
    transition: all 0.12s;
    animation: fadeIn 0.2s ease;
  }

  .task-card:hover {
    border-color: var(--border-light);
    background: rgba(31, 35, 53, 0.8);
  }

  .task-card.overdue { border-left: 3px solid var(--red); }
  .task-card.due-soon { border-left: 3px solid var(--amber); }
  .task-card.upcoming-task { border-left: 3px solid var(--accent); }
  .task-card.completed-task { border-left: 3px solid var(--green); opacity: 0.6; }

  .task-check {
    width: 20px; height: 20px;
    border-radius: 50%;
    border: 2px solid var(--border-light);
    cursor: pointer;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    margin-top: 2px;
  }

  .task-check:hover { border-color: var(--green); background: var(--green-glow); }
  .task-check.done { border-color: var(--green); background: var(--green); }
  .task-check.done::after { content: '‚úì'; color: var(--bg-deep); font-size: 12px; font-weight: 700; }

  .task-info { flex: 1; min-width: 0; }

  .task-text {
    font-size: 13.5px;
    font-weight: 500;
    margin-bottom: 4px;
    line-height: 1.4;
  }

  .task-text.done-text { text-decoration: line-through; opacity: 0.5; }

  .task-meta-row {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 11px;
    color: var(--text-muted);
    flex-wrap: wrap;
  }

  .task-assignee {
    display: flex; align-items: center; gap: 4px;
    color: var(--purple);
    font-weight: 600;
  }

  .task-due {
    font-family: 'JetBrains Mono', monospace;
  }

  .task-due.overdue-text { color: var(--red); font-weight: 600; }
  .task-due.due-soon-text { color: var(--amber); }

  .task-from-note {
    color: var(--text-muted);
    cursor: pointer;
  }
  .task-from-note:hover { color: var(--accent); text-decoration: underline; }

  .task-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .task-action-btn {
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text-muted);
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.12s;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .task-action-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  .task-action-btn.email-btn:hover {
    border-color: var(--green);
    color: var(--green);
  }

  .no-tasks-msg {
    color: var(--text-muted);
    font-size: 13px;
    padding: 20px;
    text-align: center;
    background: var(--bg-card);
    border-radius: 10px;
    border: 1px dashed var(--border);
  }

  /* ‚îÄ‚îÄ Empty States ‚îÄ‚îÄ */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-muted);
    gap: 12px;
    padding: 40px;
    text-align: center;
  }

  .empty-state svg { opacity: 0.3; }
  .empty-state p { font-size: 14px; }
  .empty-state .hint { font-size: 12px; opacity: 0.6; }

  /* ‚îÄ‚îÄ Modal Overlay ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }

  .modal-overlay.show { display: flex; }

  .modal {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    width: 440px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  }

  .modal h2 {
    font-size: 18px;
    margin-bottom: 16px;
  }

  .modal label {
    display: block;
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    margin-top: 12px;
  }

  .modal label:first-of-type { margin-top: 0; }

  .modal input, .modal select {
    width: 100%;
    padding: 9px 14px;
    background: var(--bg-input);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    outline: none;
  }

  .modal input:focus, .modal select:focus { border-color: var(--accent); }

  .modal-colors {
    display: flex;
    gap: 8px;
    margin: 12px 0 20px;
  }

  .modal-colors .color-opt {
    width: 28px; height: 28px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.15s;
  }

  .modal-colors .color-opt:hover { transform: scale(1.15); }
  .modal-colors .color-opt.selected { border-color: #fff; transform: scale(1.15); }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .modal-actions button {
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    border: none;
    transition: all 0.15s;
  }

  .btn-cancel {
    background: var(--bg-input);
    color: var(--text-secondary);
  }
  .btn-cancel:hover { background: var(--border); }

  .btn-primary {
    background: var(--accent);
    color: #fff;
  }
  .btn-primary:hover { background: var(--accent-hover); }

  .task-line-preview {
    background: var(--bg-input);
    border-radius: 6px;
    padding: 8px 12px;
    margin-bottom: 12px;
    font-size: 13px;
    color: var(--text-secondary);
    border-left: 3px solid var(--amber);
  }

  /* ‚îÄ‚îÄ Animations ‚îÄ‚îÄ */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .note-preview { animation: fadeIn 0.2s ease; }

  /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
  @media (max-width: 1100px) {
    .dash-stats { flex-wrap: wrap; }
    .dash-stat-card { min-width: 120px; }
  }

  @media (max-width: 900px) {
    .notes-list { width: 240px; min-width: 240px; }
  }

  @media (max-width: 700px) {
    .sidebar { width: 200px; min-width: 200px; }
    .notes-list { display: none; }
  }
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-brand">
    <h1>CallNotes</h1>
    <p>Phone Call Notebook</p>
  </div>

  <button class="dashboard-btn" id="dashboardBtn" onclick="openDashboard()">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="5" height="5" rx="1"></rect><rect x="9" y="2" width="5" height="5" rx="1"></rect><rect x="2" y="9" width="5" height="5" rx="1"></rect><rect x="9" y="9" width="5" height="5" rx="1"></rect></svg>
    Task Dashboard
    <span class="badge" id="dashBadge" style="display: none;">0</span>
  </button>

  <div class="sidebar-section-label">Folders</div>

  <div class="folder-list" id="folderList">
        <div class="folder-item " onclick="selectFolder(&#39;finances&#39;)">
          <span class="dot" style="background:#5ae0a0"></span>
          Finances
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;finances&#39;)" title="Delete folder">√ó</button>
        </div>
      
        <div class="folder-item " onclick="selectFolder(&#39;software-dev&#39;)">
          <span class="dot" style="background:#6c8cff"></span>
          Software Development
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;software-dev&#39;)" title="Delete folder">√ó</button>
        </div>
      
        <div class="folder-item " onclick="selectFolder(&#39;operations&#39;)">
          <span class="dot" style="background:#f0b865"></span>
          Operations
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;operations&#39;)" title="Delete folder">√ó</button>
        </div>
      
        <div class="folder-item " onclick="selectFolder(&#39;clinic-locations&#39;)">
          <span class="dot" style="background:#b08cff"></span>
          Clinic Locations
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;clinic-locations&#39;)" title="Delete folder">√ó</button>
        </div>
      
        <div class="folder-item " onclick="selectFolder(&#39;facilities&#39;)">
          <span class="dot" style="background:#ff8c5a"></span>
          Facilities
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;facilities&#39;)" title="Delete folder">√ó</button>
        </div>
      
        <div class="folder-item " onclick="selectFolder(&#39;monthly-rents&#39;)">
          <span class="dot" style="background:#ff6b7a"></span>
          Monthly Rents Due
          <span class="count">0</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder(&#39;monthly-rents&#39;)" title="Delete folder">√ó</button>
        </div>
      </div>

  <button class="add-folder-btn" onclick="openAddFolderModal()">
    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="2" x2="7" y2="12"></line><line x1="2" y1="7" x2="12" y2="7"></line></svg>
    New Folder
  </button>

  <div class="sidebar-footer">
    <span id="totalNotesCount">0 notes</span>
    <button class="export-btn" onclick="exportAllNotes()">Export All</button>
  </div>
</aside>

<!-- Main -->
<div class="main-area">
  <div class="topbar">
    <div class="topbar-folder-name" id="topbarFolderName">
      <span class="dot" id="topbarDot" style="display: none;"></span>
      <span id="topbarTitle">Select a folder</span>
    </div>
    <div class="topbar-search">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="7" r="5"></circle><line x1="11" y1="11" x2="15" y2="15"></line></svg>
      <input type="text" placeholder="Search notes‚Ä¶" id="searchInput" oninput="filterNotes()">
    </div>
    <button class="new-note-btn" id="newNoteBtn" onclick="createNote()">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="7" y1="2" x2="7" y2="12"></line><line x1="2" y1="7" x2="12" y2="7"></line></svg>
      New Note
    </button>
  </div>

  <div class="content-area">
    <!-- Notes list panel -->
    <div class="notes-list" id="notesList">
        <div class="empty-state">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="28" height="32" rx="3"></rect><line x1="12" y1="12" x2="28" y2="12"></line><line x1="12" y1="18" x2="24" y2="18"></line></svg>
          <p>Select a folder to view notes</p>
        </div></div>

    <!-- Editor panel -->
    <div class="editor-area" id="editorArea">
      <div class="empty-state" id="editorEmpty" style="display: flex;">
        <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 8h24a4 4 0 0 1 4 4v24a4 4 0 0 1-4 4H12a4 4 0 0 1-4-4V12a4 4 0 0 1 4-4z"></path><path d="M16 20h16M16 26h12M16 32h14"></path></svg>
        <p>Select or create a note to begin</p>
        <span class="hint">Your notes auto-save and are timestamped<br>Hover any line to assign a follow-up task</span>
      </div>
      <div id="editorContent" style="display:none; flex-direction:column; flex:1;">
        <div class="editor-header">
          <input class="editor-title-input" id="editorTitle" placeholder="Note title‚Ä¶" oninput="saveCurrentNote()">
          <div class="editor-meta">
            <span id="editorTimestamp"></span>
            <span class="tag" id="editorFolder"></span>
          </div>
          <div class="caller-input-row">
            <label>Caller / Contact:</label>
            <input class="caller-input" id="editorCaller" placeholder="Name or phone number‚Ä¶" oninput="saveCurrentNote()">
          </div>
        </div>
        <div class="editor-body">
          <div class="note-lines-area" id="noteLinesArea"></div>
        </div>
      </div>
    </div>

    <!-- Dashboard panel (replaces editor+notes) -->
    <div class="dashboard-view" id="dashboardView"></div>
  </div>
</div>

<!-- Add Folder Modal -->
<div class="modal-overlay" id="addFolderModal">
  <div class="modal">
    <h2>Create New Folder</h2>
    <input type="text" id="newFolderName" placeholder="Folder name‚Ä¶" onkeydown="if(event.key===&#39;Enter&#39;) addFolder()">
    <div class="modal-colors" id="colorPicker"></div>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn-primary" onclick="addFolder()">Create</button>
    </div>
  </div>
</div>

<!-- Assign Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <h2>Assign Follow-Up Task</h2>
    <div class="task-line-preview" id="taskLinePreview"></div>
    <label>Assigned To (Name)</label>
    <input type="text" id="taskAssignee" placeholder="e.g. John Smith">
    <label>Email Address</label>
    <input type="email" id="taskEmail" placeholder="e.g. john@company.com">
    <label>Due Date</label>
    <input type="date" id="taskDueDate">
    <label>Priority</label>
    <select id="taskPriority">
      <option value="normal">Normal</option>
      <option value="high">High</option>
      <option value="urgent">Urgent</option>
    </select>
    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModals()">Cancel</button>
      <button class="btn-primary" onclick="saveTask()">Assign Task</button>
    </div>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ Data ‚îÄ‚îÄ
  const COLORS = [
    '#6c8cff', '#5ae0a0', '#ff6b7a', '#f0b865',
    '#b08cff', '#ff8c5a', '#5ac8e0', '#e06caa'
  ];

  const DEFAULT_FOLDERS = [
    { id: 'finances', name: 'Finances', color: '#5ae0a0' },
    { id: 'software-dev', name: 'Software Development', color: '#6c8cff' },
    { id: 'operations', name: 'Operations', color: '#f0b865' },
    { id: 'clinic-locations', name: 'Clinic Locations', color: '#b08cff' },
    { id: 'facilities', name: 'Facilities', color: '#ff8c5a' },
    { id: 'monthly-rents', name: 'Monthly Rents Due', color: '#ff6b7a' },
  ];

  let state = loadState();
  let activeFolder = null;
  let activeNote = null;
  let searchQuery = '';
  let selectedColor = COLORS[0];
  let dashboardActive = false;
  let dashFilter = 'all';

  // Pending task assignment context
  let pendingTaskNoteId = null;
  let pendingTaskLineIdx = null;

  function loadState() {
    try {
      const saved = localStorage.getItem('callnotes_v2_state');
      if (saved) return JSON.parse(saved);
    } catch (e) {}
    return { folders: DEFAULT_FOLDERS, notes: [] };
  }

  function saveState() {
    localStorage.setItem('callnotes_v2_state', JSON.stringify(state));
  }

  function genId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2, 6);
  }

  function formatDate(ts) {
    const d = new Date(ts);
    const date = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    const time = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    return `${date} ¬∑ ${time}`;
  }

  function formatShortDate(ts) {
    const d = new Date(ts);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function formatDueDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function daysUntilDue(dateStr) {
    const due = new Date(dateStr + 'T23:59:59');
    const now = new Date();
    return Math.ceil((due - now) / (1000 * 60 * 60 * 24));
  }

  // ‚îÄ‚îÄ Get all tasks ‚îÄ‚îÄ
  function getAllTasks() {
    const tasks = [];
    state.notes.forEach(note => {
      if (!note.lines) return;
      note.lines.forEach((line, idx) => {
        if (line.task) {
          tasks.push({
            ...line.task,
            lineText: line.text,
            noteId: note.id,
            noteTitle: note.title || 'Untitled',
            folderId: note.folderId,
            lineIdx: idx,
          });
        }
      });
    });
    return tasks;
  }

  function getOpenTaskCount() {
    return getAllTasks().filter(t => !t.completed).length;
  }

  // ‚îÄ‚îÄ Render Functions ‚îÄ‚îÄ
  function renderFolders() {
    const list = document.getElementById('folderList');
    list.innerHTML = state.folders.map(f => {
      const count = state.notes.filter(n => n.folderId === f.id).length;
      const isActive = activeFolder === f.id && !dashboardActive;
      return `
        <div class="folder-item ${isActive ? 'active' : ''}" onclick="selectFolder('${f.id}')">
          <span class="dot" style="background:${f.color}"></span>
          ${escHtml(f.name)}
          <span class="count">${count}</span>
          <button class="delete-folder" onclick="event.stopPropagation(); deleteFolder('${f.id}')" title="Delete folder">√ó</button>
        </div>
      `;
    }).join('');

    const total = state.notes.length;
    document.getElementById('totalNotesCount').textContent = `${total} note${total !== 1 ? 's' : ''}`;

    // Update dashboard badge
    const openCount = getOpenTaskCount();
    document.getElementById('dashBadge').textContent = openCount;
    document.getElementById('dashBadge').style.display = openCount > 0 ? '' : 'none';
    document.getElementById('dashboardBtn').classList.toggle('active', dashboardActive);
  }

  function renderNotes() {
    const list = document.getElementById('notesList');
    if (!activeFolder) {
      list.innerHTML = `
        <div class="empty-state">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="28" height="32" rx="3"/><line x1="12" y1="12" x2="28" y2="12"/><line x1="12" y1="18" x2="24" y2="18"/></svg>
          <p>Select a folder to view notes</p>
        </div>`;
      return;
    }

    let notes = state.notes
      .filter(n => n.folderId === activeFolder)
      .sort((a, b) => b.updatedAt - a.updatedAt);

    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      notes = notes.filter(n =>
        n.title.toLowerCase().includes(q) ||
        (n.lines || []).some(l => l.text.toLowerCase().includes(q)) ||
        (n.caller || '').toLowerCase().includes(q)
      );
    }

    if (notes.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="6" y="4" width="28" height="32" rx="3"/><line x1="12" y1="12" x2="28" y2="12"/></svg>
          <p>${searchQuery ? 'No matching notes' : 'No notes in this folder'}</p>
          <span class="hint">${searchQuery ? 'Try a different search' : 'Click "New Note" to create one'}</span>
        </div>`;
      return;
    }

    list.innerHTML = notes.map(n => {
      const isActive = activeNote === n.id;
      const bodyText = (n.lines || []).map(l => l.text).join(' ');
      const snippet = bodyText.substring(0, 80) || 'Empty note‚Ä¶';
      const caller = n.caller ? `üìû ${escHtml(n.caller)}` : '';
      const taskCount = (n.lines || []).filter(l => l.task && !l.task.completed).length;
      return `
        <div class="note-preview ${isActive ? 'active' : ''}" onclick="selectNote('${n.id}')">
          <div class="note-preview-title">${escHtml(n.title || 'Untitled Note')}</div>
          <div class="note-preview-snippet">${escHtml(snippet)}</div>
          <div class="note-preview-meta">
            <span>${formatShortDate(n.updatedAt)}</span>
            ${caller ? `<span>${caller}</span>` : ''}
            ${taskCount > 0 ? `<span class="note-preview-tasks">‚ö° ${taskCount} task${taskCount>1?'s':''}</span>` : ''}
          </div>
          <button class="delete-note" onclick="event.stopPropagation(); deleteNote('${n.id}')">√ó</button>
        </div>
      `;
    }).join('');
  }

  function renderEditor() {
    const empty = document.getElementById('editorEmpty');
    const content = document.getElementById('editorContent');

    if (!activeNote) {
      empty.style.display = 'flex';
      content.style.display = 'none';
      return;
    }

    const note = state.notes.find(n => n.id === activeNote);
    if (!note) return;

    empty.style.display = 'none';
    content.style.display = 'flex';

    document.getElementById('editorTitle').value = note.title;
    document.getElementById('editorCaller').value = note.caller || '';
    document.getElementById('editorTimestamp').textContent = formatDate(note.createdAt);

    const folder = state.folders.find(f => f.id === note.folderId);
    const folderTag = document.getElementById('editorFolder');
    if (folder) {
      folderTag.textContent = folder.name;
      folderTag.style.display = '';
    } else {
      folderTag.style.display = 'none';
    }

    renderNoteLines(note);
  }

  function renderNoteLines(note) {
    const area = document.getElementById('noteLinesArea');
    if (!note.lines) note.lines = [{ text: '', task: null }];

    // Ensure at least one empty line at the end
    if (note.lines.length === 0 || note.lines[note.lines.length - 1].text !== '') {
      note.lines.push({ text: '', task: null });
    }

    area.innerHTML = note.lines.map((line, idx) => {
      const hasTask = !!line.task;
      const taskHtml = hasTask ? renderLineTaskIndicator(line.task, note.id, idx) : '';
      return `
        <div class="note-line" data-idx="${idx}">
          <span class="note-line-number">${idx + 1}</span>
          <input class="note-line-input ${hasTask ? 'has-task' : ''}"
                 value="${escAttr(line.text)}"
                 placeholder="${idx === 0 ? 'Start typing your call notes‚Ä¶' : ''}"
                 oninput="onLineInput(${idx}, this)"
                 onkeydown="onLineKeydown(event, ${idx})"
                 data-idx="${idx}">
          <button class="line-task-btn ${hasTask ? 'has-task' : ''}"
                  onclick="openTaskModal('${note.id}', ${idx})"
                  title="${hasTask ? 'Edit task' : 'Assign follow-up'}">
            ${hasTask ? '‚ö°' : '+ Task'}
          </button>
        </div>
        ${taskHtml ? `<div style="padding-left:38px; padding-right:12px; padding-bottom:4px;">${taskHtml}</div>` : ''}
      `;
    }).join('');
  }

  function renderLineTaskIndicator(task, noteId, lineIdx) {
    const days = daysUntilDue(task.dueDate);
    let dueLabel = formatDueDate(task.dueDate);
    let dueClass = '';
    if (task.completed) {
      dueLabel = '‚úì Completed';
      dueClass = 'color: var(--green)';
    } else if (days < 0) {
      dueLabel = `OVERDUE (${Math.abs(days)}d)`;
      dueClass = 'color: var(--red); font-weight:600';
    } else if (days <= 3) {
      dueLabel = `Due in ${days}d`;
      dueClass = 'color: var(--amber)';
    }

    const emailHref = task.email ? buildEmailLink(task, noteId, lineIdx) : '';
    const completedStyle = task.completed ? 'opacity:0.5;' : '';

    return `
      <div class="line-task-indicator" style="${completedStyle}">
        <span class="assignee">${escHtml(task.assignee)}</span>
        <span class="due" style="${dueClass}">${dueLabel}</span>
        ${task.priority === 'urgent' ? '<span style="color:var(--red)">üî¥</span>' : task.priority === 'high' ? '<span style="color:var(--amber)">üü°</span>' : ''}
        ${emailHref ? `<a class="email-link" href="${emailHref}" title="Send email">‚úâ</a>` : ''}
        ${!task.completed ? `<span class="line-task-complete" onclick="toggleTaskComplete('${noteId}', ${lineIdx})" title="Mark complete">‚òê</span>` : `<span class="line-task-complete" onclick="toggleTaskComplete('${noteId}', ${lineIdx})" title="Mark incomplete" style="color:var(--green)">‚òë</span>`}
        <span class="remove-task" onclick="removeTask('${noteId}', ${lineIdx})" title="Remove task">√ó</span>
      </div>
    `;
  }

  function buildEmailLink(task, noteId, lineIdx) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note) return '';
    const folder = state.folders.find(f => f.id === note.folderId);
    const folderName = folder ? folder.name : '';
    const lineText = note.lines[lineIdx] ? note.lines[lineIdx].text : '';

    const subject = encodeURIComponent(`Follow-Up Task: ${lineText.substring(0, 60) || note.title || 'Action Required'}`);
    const body = encodeURIComponent(
      `Hi ${task.assignee},\n\n` +
      `You have been assigned a follow-up task from a phone call note.\n\n` +
      `üìã Task: ${lineText}\n` +
      `üìÅ Folder: ${folderName}\n` +
      `üìù Note: ${note.title || 'Untitled'}\n` +
      `üìû Call with: ${note.caller || 'N/A'}\n` +
      `üìÖ Due Date: ${formatDueDate(task.dueDate)}\n` +
      `‚ö° Priority: ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}\n\n` +
      `Please ensure this is completed by the due date.\n\n` +
      `Thank you!`
    );
    return `mailto:${encodeURIComponent(task.email)}?subject=${subject}&body=${body}`;
  }

  // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ
  function renderDashboard() {
    const view = document.getElementById('dashboardView');
    const tasks = getAllTasks();

    const overdue = tasks.filter(t => !t.completed && daysUntilDue(t.dueDate) < 0);
    const dueSoon = tasks.filter(t => !t.completed && daysUntilDue(t.dueDate) >= 0 && daysUntilDue(t.dueDate) <= 3);
    const upcoming = tasks.filter(t => !t.completed && daysUntilDue(t.dueDate) > 3);
    const completed = tasks.filter(t => t.completed);

    let filteredTasks;
    if (dashFilter === 'overdue') filteredTasks = overdue;
    else if (dashFilter === 'due-soon') filteredTasks = dueSoon;
    else if (dashFilter === 'upcoming') filteredTasks = upcoming;
    else if (dashFilter === 'completed') filteredTasks = completed;
    else filteredTasks = [...overdue, ...dueSoon, ...upcoming, ...completed];

    // Sort: overdue first, then by due date
    filteredTasks.sort((a, b) => {
      if (a.completed !== b.completed) return a.completed ? 1 : -1;
      return new Date(a.dueDate) - new Date(b.dueDate);
    });

    view.innerHTML = `
      <div class="dash-header">
        <h2>Task Dashboard</h2>
        <p>Follow-up tasks from your phone call notes</p>
      </div>

      <div class="dash-stats">
        <div class="dash-stat-card overdue">
          <div class="label">Overdue</div>
          <div class="value">${overdue.length}</div>
        </div>
        <div class="dash-stat-card due-soon">
          <div class="label">Due Soon (‚â§3 days)</div>
          <div class="value">${dueSoon.length}</div>
        </div>
        <div class="dash-stat-card upcoming">
          <div class="label">Upcoming</div>
          <div class="value">${upcoming.length}</div>
        </div>
        <div class="dash-stat-card completed">
          <div class="label">Completed</div>
          <div class="value">${completed.length}</div>
        </div>
      </div>

      <div class="dash-filter-row">
        <button class="dash-filter-btn ${dashFilter==='all'?'active':''}" onclick="setDashFilter('all')">All (${tasks.length})</button>
        <button class="dash-filter-btn ${dashFilter==='overdue'?'active':''}" onclick="setDashFilter('overdue')">üî¥ Overdue (${overdue.length})</button>
        <button class="dash-filter-btn ${dashFilter==='due-soon'?'active':''}" onclick="setDashFilter('due-soon')">üü° Due Soon (${dueSoon.length})</button>
        <button class="dash-filter-btn ${dashFilter==='upcoming'?'active':''}" onclick="setDashFilter('upcoming')">üîµ Upcoming (${upcoming.length})</button>
        <button class="dash-filter-btn ${dashFilter==='completed'?'active':''}" onclick="setDashFilter('completed')">‚úÖ Completed (${completed.length})</button>
      </div>

      ${filteredTasks.length === 0
        ? `<div class="no-tasks-msg">${dashFilter === 'all' ? 'No tasks assigned yet. Open a note and hover any line to assign a follow-up task.' : 'No tasks in this category.'}</div>`
        : filteredTasks.map(t => renderTaskCard(t)).join('')
      }
    `;
  }

  function renderTaskCard(task) {
    const days = daysUntilDue(task.dueDate);
    let statusClass = 'upcoming-task';
    let dueText = formatDueDate(task.dueDate);
    let dueClass = '';

    if (task.completed) {
      statusClass = 'completed-task';
      dueText = 'Completed';
      dueClass = '';
    } else if (days < 0) {
      statusClass = 'overdue';
      dueText = `OVERDUE by ${Math.abs(days)} day${Math.abs(days)>1?'s':''}`;
      dueClass = 'overdue-text';
    } else if (days <= 3) {
      statusClass = 'due-soon';
      dueText = days === 0 ? 'Due TODAY' : `Due in ${days} day${days>1?'s':''}`;
      dueClass = 'due-soon-text';
    }

    const folder = state.folders.find(f => f.id === task.folderId);
    const folderName = folder ? folder.name : '';
    const emailHref = task.email ? buildEmailLink(task, task.noteId, task.lineIdx) : '';

    return `
      <div class="task-card ${statusClass}">
        <div class="task-check ${task.completed?'done':''}" onclick="toggleTaskFromDash('${task.noteId}', ${task.lineIdx})"></div>
        <div class="task-info">
          <div class="task-text ${task.completed?'done-text':''}">${escHtml(task.lineText || 'No description')}</div>
          <div class="task-meta-row">
            <span class="task-assignee">üë§ ${escHtml(task.assignee)}</span>
            <span class="task-due ${dueClass}">üìÖ ${dueText}</span>
            ${task.priority !== 'normal' ? `<span>${task.priority === 'urgent' ? 'üî¥ Urgent' : 'üü° High'}</span>` : ''}
            <span class="task-from-note" onclick="jumpToNote('${task.noteId}')">üìù ${escHtml(task.noteTitle)} ‚Äî ${escHtml(folderName)}</span>
          </div>
        </div>
        <div class="task-actions">
          ${emailHref ? `<a class="task-action-btn email-btn" href="${emailHref}" title="Send follow-up email">‚úâ Email</a>` : ''}
          <button class="task-action-btn" onclick="jumpToNote('${task.noteId}')" title="Go to note">‚Üí Note</button>
        </div>
      </div>
    `;
  }

  function setDashFilter(f) {
    dashFilter = f;
    renderDashboard();
  }

  function openDashboard() {
    dashboardActive = true;
    activeNote = null;
    document.getElementById('notesList').style.display = 'none';
    document.getElementById('editorArea').style.display = 'none';
    document.getElementById('dashboardView').style.display = 'block';
    document.getElementById('dashboardView').classList.add('active');
    document.getElementById('newNoteBtn').style.display = 'none';
    document.getElementById('topbarDot').style.background = 'var(--amber)';
    document.getElementById('topbarDot').style.display = '';
    document.getElementById('topbarTitle').textContent = 'Task Dashboard';
    renderFolders();
    renderDashboard();
  }

  function closeDashboard() {
    dashboardActive = false;
    document.getElementById('notesList').style.display = '';
    document.getElementById('editorArea').style.display = '';
    document.getElementById('dashboardView').style.display = 'none';
    document.getElementById('dashboardView').classList.remove('active');
    document.getElementById('newNoteBtn').style.display = '';
  }

  function jumpToNote(noteId) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note) return;
    closeDashboard();
    activeFolder = note.folderId;
    activeNote = noteId;
    renderFolders();
    renderNotes();
    renderEditor();
    updateTopbar();
  }

  // ‚îÄ‚îÄ Topbar ‚îÄ‚îÄ
  function updateTopbar() {
    if (dashboardActive) return;
    const dot = document.getElementById('topbarDot');
    const title = document.getElementById('topbarTitle');

    if (activeFolder) {
      const f = state.folders.find(fo => fo.id === activeFolder);
      if (f) {
        dot.style.background = f.color;
        dot.style.display = '';
        title.textContent = f.name;
        return;
      }
    }
    dot.style.display = 'none';
    title.textContent = 'Select a folder';
  }

  // ‚îÄ‚îÄ Line editing ‚îÄ‚îÄ
  function onLineInput(idx, el) {
    const note = state.notes.find(n => n.id === activeNote);
    if (!note || !note.lines[idx]) return;
    note.lines[idx].text = el.value;

    // Add new line if typing on last line
    if (idx === note.lines.length - 1 && el.value !== '') {
      note.lines.push({ text: '', task: null });
      // Don't re-render, just save
    }

    note.updatedAt = Date.now();
    saveState();
    // Light update of sidebar counts
    renderNotes();
  }

  function onLineKeydown(e, idx) {
    const note = state.notes.find(n => n.id === activeNote);
    if (!note) return;

    if (e.key === 'Enter') {
      e.preventDefault();
      // Insert new line after current
      note.lines.splice(idx + 1, 0, { text: '', task: null });
      note.updatedAt = Date.now();
      saveState();
      renderNoteLines(note);
      // Focus new line
      setTimeout(() => {
        const inputs = document.querySelectorAll('.note-line-input');
        if (inputs[idx + 1]) inputs[idx + 1].focus();
      }, 30);
    }

    if (e.key === 'Backspace' && note.lines[idx].text === '' && note.lines.length > 1) {
      e.preventDefault();
      // Don't delete if line has a task
      if (note.lines[idx].task) return;
      note.lines.splice(idx, 1);
      note.updatedAt = Date.now();
      saveState();
      renderNoteLines(note);
      setTimeout(() => {
        const inputs = document.querySelectorAll('.note-line-input');
        const focusIdx = Math.max(0, idx - 1);
        if (inputs[focusIdx]) {
          inputs[focusIdx].focus();
          inputs[focusIdx].setSelectionRange(inputs[focusIdx].value.length, inputs[focusIdx].value.length);
        }
      }, 30);
    }

    if (e.key === 'ArrowDown') {
      const inputs = document.querySelectorAll('.note-line-input');
      if (inputs[idx + 1]) { e.preventDefault(); inputs[idx + 1].focus(); }
    }
    if (e.key === 'ArrowUp') {
      const inputs = document.querySelectorAll('.note-line-input');
      if (inputs[idx - 1]) { e.preventDefault(); inputs[idx - 1].focus(); }
    }
  }

  // ‚îÄ‚îÄ Task Management ‚îÄ‚îÄ
  function openTaskModal(noteId, lineIdx) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note || !note.lines[lineIdx]) return;

    pendingTaskNoteId = noteId;
    pendingTaskLineIdx = lineIdx;

    const line = note.lines[lineIdx];
    document.getElementById('taskLinePreview').textContent = line.text || '(empty line)';

    if (line.task) {
      document.getElementById('taskAssignee').value = line.task.assignee || '';
      document.getElementById('taskEmail').value = line.task.email || '';
      document.getElementById('taskDueDate').value = line.task.dueDate || '';
      document.getElementById('taskPriority').value = line.task.priority || 'normal';
    } else {
      document.getElementById('taskAssignee').value = '';
      document.getElementById('taskEmail').value = '';
      // Default due date: 3 days from now
      const d = new Date();
      d.setDate(d.getDate() + 3);
      document.getElementById('taskDueDate').value = d.toISOString().split('T')[0];
      document.getElementById('taskPriority').value = 'normal';
    }

    document.getElementById('taskModal').classList.add('show');
    setTimeout(() => document.getElementById('taskAssignee').focus(), 100);
  }

  function saveTask() {
    const assignee = document.getElementById('taskAssignee').value.trim();
    const email = document.getElementById('taskEmail').value.trim();
    const dueDate = document.getElementById('taskDueDate').value;
    const priority = document.getElementById('taskPriority').value;

    if (!assignee) { alert('Please enter an assignee name.'); return; }
    if (!dueDate) { alert('Please select a due date.'); return; }

    const note = state.notes.find(n => n.id === pendingTaskNoteId);
    if (!note || !note.lines[pendingTaskLineIdx]) return;

    note.lines[pendingTaskLineIdx].task = {
      assignee,
      email,
      dueDate,
      priority,
      completed: false,
      createdAt: Date.now()
    };

    note.updatedAt = Date.now();
    saveState();
    closeModals();
    renderNoteLines(note);
    renderNotes();
    renderFolders();
  }

  function removeTask(noteId, lineIdx) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note || !note.lines[lineIdx]) return;
    if (!confirm('Remove this task assignment?')) return;
    note.lines[lineIdx].task = null;
    note.updatedAt = Date.now();
    saveState();
    renderNoteLines(note);
    renderNotes();
    renderFolders();
  }

  function toggleTaskComplete(noteId, lineIdx) {
    const note = state.notes.find(n => n.id === noteId);
    if (!note || !note.lines[lineIdx] || !note.lines[lineIdx].task) return;
    note.lines[lineIdx].task.completed = !note.lines[lineIdx].task.completed;
    note.updatedAt = Date.now();
    saveState();
    renderNoteLines(note);
    renderFolders();
  }

  function toggleTaskFromDash(noteId, lineIdx) {
    toggleTaskComplete(noteId, lineIdx);
    renderDashboard();
  }

  // ‚îÄ‚îÄ Folder/Note Actions ‚îÄ‚îÄ
  function selectFolder(id) {
    closeDashboard();
    activeFolder = id;
    activeNote = null;
    searchQuery = '';
    document.getElementById('searchInput').value = '';
    renderFolders();
    renderNotes();
    renderEditor();
    updateTopbar();
  }

  function selectNote(id) {
    activeNote = id;
    renderNotes();
    renderEditor();
  }

  function createNote() {
    if (!activeFolder) {
      alert('Please select a folder first.');
      return;
    }
    const now = Date.now();
    const note = {
      id: genId(),
      folderId: activeFolder,
      title: '',
      caller: '',
      lines: [{ text: '', task: null }],
      createdAt: now,
      updatedAt: now
    };
    state.notes.push(note);
    activeNote = note.id;
    saveState();
    renderFolders();
    renderNotes();
    renderEditor();
    document.getElementById('editorTitle').focus();
  }

  function saveCurrentNote() {
    if (!activeNote) return;
    const note = state.notes.find(n => n.id === activeNote);
    if (!note) return;

    note.title = document.getElementById('editorTitle').value;
    note.caller = document.getElementById('editorCaller').value;
    note.updatedAt = Date.now();

    saveState();
    renderNotes();
    renderFolders();
  }

  function deleteNote(id) {
    if (!confirm('Delete this note and all its tasks?')) return;
    state.notes = state.notes.filter(n => n.id !== id);
    if (activeNote === id) activeNote = null;
    saveState();
    renderFolders();
    renderNotes();
    renderEditor();
  }

  function deleteFolder(id) {
    const noteCount = state.notes.filter(n => n.folderId === id).length;
    const msg = noteCount > 0
      ? `Delete this folder and its ${noteCount} note(s)?`
      : 'Delete this folder?';
    if (!confirm(msg)) return;

    state.folders = state.folders.filter(f => f.id !== id);
    state.notes = state.notes.filter(n => n.folderId !== id);
    if (activeFolder === id) { activeFolder = null; activeNote = null; }
    saveState();
    renderFolders();
    renderNotes();
    renderEditor();
    updateTopbar();
  }

  function filterNotes() {
    searchQuery = document.getElementById('searchInput').value;
    renderNotes();
  }

  // ‚îÄ‚îÄ Modals ‚îÄ‚îÄ
  function openAddFolderModal() {
    document.getElementById('addFolderModal').classList.add('show');
    document.getElementById('newFolderName').value = '';
    selectedColor = COLORS[0];
    renderColorPicker();
    setTimeout(() => document.getElementById('newFolderName').focus(), 100);
  }

  function closeModals() {
    document.getElementById('addFolderModal').classList.remove('show');
    document.getElementById('taskModal').classList.remove('show');
  }

  function renderColorPicker() {
    document.getElementById('colorPicker').innerHTML = COLORS.map(c =>
      `<div class="color-opt ${selectedColor === c ? 'selected' : ''}" 
            style="background:${c}" 
            onclick="selectedColor='${c}'; renderColorPicker()"></div>`
    ).join('');
  }

  function addFolder() {
    const name = document.getElementById('newFolderName').value.trim();
    if (!name) return;

    state.folders.push({
      id: genId(),
      name,
      color: selectedColor
    });
    saveState();
    renderFolders();
    closeModals();
  }

  // ‚îÄ‚îÄ Export ‚îÄ‚îÄ
  function exportAllNotes() {
    let text = 'CALLNOTES ‚Äî EXPORTED NOTES\n';
    text += '='.repeat(50) + '\n\n';

    state.folders.forEach(f => {
      const folderNotes = state.notes
        .filter(n => n.folderId === f.id)
        .sort((a, b) => b.createdAt - a.createdAt);

      if (folderNotes.length === 0) return;

      text += `\nüìÅ ${f.name}\n`;
      text += '‚îÄ'.repeat(40) + '\n';

      folderNotes.forEach(n => {
        text += `\n  üìù ${n.title || 'Untitled'}\n`;
        text += `  Created: ${formatDate(n.createdAt)}\n`;
        if (n.caller) text += `  Caller: ${n.caller}\n`;
        text += `  ${'‚îÄ'.repeat(30)}\n`;

        (n.lines || []).forEach((line, idx) => {
          if (!line.text && !line.task) return;
          text += `  ${line.text}\n`;
          if (line.task) {
            text += `    ‚ö° TASK ‚Üí ${line.task.assignee}`;
            if (line.task.email) text += ` (${line.task.email})`;
            text += ` | Due: ${formatDueDate(line.task.dueDate)}`;
            text += ` | Priority: ${line.task.priority}`;
            text += ` | ${line.task.completed ? 'COMPLETED' : 'OPEN'}\n`;
          }
        });
        text += '\n';
      });
    });

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `callnotes_export_${new Date().toISOString().slice(0, 10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ
  function escHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function escAttr(str) {
    return str.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ‚îÄ‚îÄ Keyboard shortcut ‚îÄ‚îÄ
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      createNote();
    }
    if (e.key === 'Escape') closeModals();
  });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  renderFolders();
  renderNotes();
  renderEditor();
  updateTopbar();
</script>


</body></html>
